#!/usr/bin/env perl
# Copyright 2019 Kevin Spencer <kevin@kevinspencer.org>
#
# Permission to use, copy, modify, distribute, and sell this software and its
# documentation for any purpose is hereby granted without fee, provided that
# the above copyright notice appear in all copies and that both that
# copyright notice and this permission notice appear in supporting
# documentation. No representations are made about the suitability of this
# software for any purpose. It is provided "as is" without express or
# implied warranty.
#
################################################################################

use Data::Dumper;
use JSON::XS;
use Mojo::UserAgent;
use Mojo::URL;
use utf8;
use strict;
use warnings;

$Data::Dumper::Indent = 1;

our $VERSION = '0.10';

# by default we'll run in queue mode and ask the backend for the things
# but override that if text provided on STDIN

my $tweet_from_stdin = shift;

my $bot = Mojo::UserAgent->new();
my $url = Mojo::URL->new('http://localhost:3000/queue');

if ($tweet_from_stdin) {
    my $tx = $bot->post($url => {Accept => '*/*'} => json => {tweet => $tweet_from_stdin});
    if ($tx->res()->code() =~ /^2/) {
        print "Added tweet to queue.\n";
    } else {
        print "ERROR: couldn't add tweet to queue: " . $tx->res()->code() . " - " . $tx->res()->message(), "\n";
    }
} else {
    $bot->max_redirects(3);
    my $tx = $bot->get($url);
    if ($tx->res()->code() =~ /^2/) {
        my $data_struct = decode_json($tx->res()->body());
        print Dumper $data_struct;
    } else {
        print "ERROR: couldn't retrieve tweets from queue: " . $tx->res()->code() . " - " . $tx->res()->message(), "\n";
    }
}
